/**
 * Copyright (c) 2014, 2017, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
/*
 Copyright 2013 jQuery Foundation and other contributors
 Released under the MIT license.
 http://jquery.org/license
*/
define(["ojs/ojcore","jquery","ojs/ojdatasource-common","ojs/ojmodel"],function(a,g){a.Xd=function(c,b){this.data={};if(!(c instanceof a.t))throw Error(a.ha.Pd._ERR_DATA_INVALID_TYPE_SUMMARY+"\n"+a.ha.Pd._ERR_DATA_INVALID_TYPE_DETAIL);a.Xd.O.constructor.call(this,c,b);this.qe=c;this.Awa();this.Init();if(null!=b&&("enabled"==b.startFetch||null==b.startFetch)||null==b)this.YH=!0};o_("CollectionTableDataSource",a.Xd,a);a.f.xa(a.Xd,a.ha,"oj.CollectionTableDataSource");a.Xd.prototype.rn=null;a.f.j("CollectionTableDataSource.prototype.comparator",
{rn:a.Xd.prototype.rn});a.Xd.prototype.Init=function(){a.Xd.O.Init.call(this)};a.f.j("CollectionTableDataSource.prototype.Init",{Init:a.Xd.prototype.Init});a.Xd.prototype.at=function(c,b){b=b||{};b.deferred=!0;var d=this.qe.at(c,b),e=this;e.JG=!0;var f;return new Promise(function(b,g){null!=d?d.then(function(a){e.JG=!1;f={data:a.attributes,index:c,key:a.id};b(f)},function(b){e.JG=!1;a.ha.O.handleEvent.call(e,a.ha.aa.ERROR,b);g(b)}):b(null)})};a.f.j("CollectionTableDataSource.prototype.at",{at:a.Xd.prototype.at});
a.Xd.prototype.fetch=function(a){a=a||{};return"init"!=a.fetchType||this.YH?this.xh(a):Promise.resolve()};a.f.j("CollectionTableDataSource.prototype.fetch",{fetch:a.Xd.prototype.fetch});a.Xd.prototype.get=function(c,b){b=b||{};b.deferred=!0;var d=this.qe.get(c,b),e=this,f;return new Promise(function(b,c){null!=d?d.then(function(a){f={data:a.attributes,index:a.index,key:a.id};b(f)},function(b){a.ha.O.handleEvent.call(e,a.ha.aa.ERROR,b);c(b)}):b(null)})};a.f.j("CollectionTableDataSource.prototype.get",
{get:a.Xd.prototype.get});a.Xd.prototype.sort=function(a){null==a?a=this.sortCriteria:this.sortCriteria=a;var b=this.comparator,d=this;return new Promise(function(e){null==b?(d.qe.comparator=a.key,d.qe.sortDirection="ascending"==a.direction?1:-1):d.qe.comparator=b;d.qe.sort(null);e({header:a.key,direction:a.direction})})};a.f.j("CollectionTableDataSource.prototype.sort",{sort:a.Xd.prototype.sort});a.Xd.prototype.totalSize=function(){var a=0<=this.qe.totalResults?this.qe.totalResults:-1;if(-1<a){var b=
this.qe.size();return b>a?b:a}if(0<this.vX)a=this.vX;else if("atLeast"==this.totalSizeConfidence())return this.qe.size();return a};a.f.j("CollectionTableDataSource.prototype.totalSize",{totalSize:a.Xd.prototype.totalSize});a.Xd.prototype.totalSizeConfidence=function(){return 0<=this.qe.totalResults?"actual":this.qe.hasMore?"atLeast":"unknown"};a.f.j("CollectionTableDataSource.prototype.totalSizeConfidence",{totalSizeConfidence:a.Xd.prototype.totalSizeConfidence});a.Xd.prototype.Awa=function(){var c=
this;this.qe.on(a.sa.aa.SYNC,function(b){if(b instanceof a.T)a.ha.O.handleEvent.call(c,a.ha.aa.CHANGE,{data:[b.attributes],keys:[b.id],indexes:[b.index]});else if(b instanceof a.t&&!c.JG&&!c.mga){var d=b.offset,e=b.lastFetchCount||b.lastFetchSize;0<e||c.qe.Fb()?(c.Aa=d,c.Bb=e,c.JG=!0,b.dA(d,d+e).then(function(a){c.JG=!1;var b=[],e=[],g,m;for(g=0;g<a.length;g++)null!=a[g]&&(m=a[g].clone(),b.push(m.attributes),e.push(m.id));c.Bo.call(c,{silent:!1},{data:b,keys:e,startIndex:d},null)})):(b=c.zB(),c.Bo.call(c,
{silent:!1},b,null))}});this.qe.on(a.sa.aa.ALLADDED,function(b,d){var e=[],f=[],g=[],k,l;for(k=0;k<d.length;k++)l=d[k].clone(),e.push(l.attributes),f.push(l.id),g.push(l.index);a.ha.O.handleEvent.call(c,a.ha.aa.ADD,{data:e,keys:f,indexes:g})});this.qe.on(a.sa.aa.ALLREMOVED,function(b,d){var e=[],f=[],g=[],k,l;for(k=0;k<d.length;k++)l=d[k].clone(),e.push(l.attributes),f.push(l.id),g.push(l.index);a.ha.O.handleEvent.call(c,a.ha.aa.REMOVE,{data:e,keys:f,indexes:g})});this.qe.on(a.sa.aa.RESET,function(b){a.ha.O.handleEvent.call(c,
a.ha.aa.RESET,b)});this.qe.on(a.sa.aa.SORT,function(b,d){if(null==d||!d.add){var e={};null==b||null==!b.comparator||g.isFunction(b.comparator)||(e.header=b.comparator,e.direction=1===b.sortDirection?"ascending":"descending");a.ha.O.handleEvent.call(c,a.ha.aa.SORT,e)}});this.qe.on(a.sa.aa.CHANGE,function(b){a.ha.O.handleEvent.call(c,a.ha.aa.CHANGE,{data:[b.attributes],keys:[b.id],indexes:[b.index]})});this.qe.on(a.sa.aa.DESTROY,function(b){a.ha.O.handleEvent.call(c,a.ha.aa.DESTROY,b)});this.qe.on(a.sa.aa.REFRESH,
function(b){a.ha.O.handleEvent.call(c,a.ha.aa.REFRESH,b)});this.qe.on(a.sa.aa.ERROR,function(b,d,e){a.ha.O.handleEvent.call(c,a.ha.aa.ERROR,b,d,e)});this.qe.on(a.sa.aa.REQUEST,function(b){a.ha.O.handleEvent.call(c,a.ha.aa.REQUEST,b)})};a.Xd.prototype.xh=function(a){this.XH(a);a=a||{};var b=this;this.zga=0<a.pageSize?!0:!1;this.Aa=null==a.startIndex?this.Aa:a.startIndex;this.Bb=0<a.pageSize?a.pageSize:-1;a.pageSize=this.Bb;a.startIndex=this.Aa;a.refresh=!0;return new Promise(function(d,e){var f=b.Bb;
b.zga||(f=25);b.qe.VD(b.Aa,f).then(function(e){var f;if(b.zga||b.qe.Fb()){f=[];var g=[],m,p;for(m=0;m<e.models.length;m++)p=e.models[m].clone(),f[m]=p.attributes,g[m]=p.id;f={data:f,keys:g,startIndex:b.Aa};e.models.length<b.Bb?0>b.totalSize()&&(b.vX=b.Aa+e.models.length):b.vX=null}else f=b.zB();b.Bo.call(b,a,f,null);d(f)},function(d){b.Bo.call(b,a,null,d);e(d)})})};a.Xd.prototype.XH=function(c){this.mga=!0;c.silent||a.ha.O.handleEvent.call(this,a.ha.aa.REQUEST,{startIndex:c.startIndex})};a.Xd.prototype.Bo=
function(c,b,d){this.mga=!1;null!=d?a.ha.O.handleEvent.call(this,a.ha.aa.ERROR,d):c.silent||a.ha.O.handleEvent.call(this,a.ha.aa.SYNC,b)};a.Xd.prototype.zB=function(){var a=this.qe.size()-1,b=[],d=[],e,f,g;for(e=0;e<=a;e++)f=this.qe.at(e),g=f.clone(),f=this.qn(g,g.attributes),b[e]=f,d[e]=g.id;return{data:b,keys:d,startIndex:this.Aa}};a.Xd.prototype.getCapability=function(){return null};a.f.j("CollectionTableDataSource.prototype.getCapability",{getCapability:a.Xd.prototype.getCapability});a.Xd.prototype.qn=
function(a,b){var d={},e;for(e in b)b.hasOwnProperty(e)&&function(){var b=e;Object.defineProperty(d,e,{get:function(){return a.get(b)},set:function(d){a.set(b,d,{silent:!0})},enumerable:!0})}();return d}});